[gcode_macro _NOZZLE_CHANGE]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M118 Nozzle change requested...
    {% if S.cold_swap_hotend %}
        _cold_nozzle
    {% else %}
        _hot_nozzle
    {% endif %}

[gcode_macro _hot_nozzle]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M118 Heating to {S.nozzle_swap_temp}C...
    M104 S{S.nozzle_swap_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S.nozzle_swap_temp}
    M118 Retracting filament...
    _Retract
    G4 P2000
    RESPOND TYPE=command MSG="action:prompt_begin Swap Nozzle"
    RESPOND TYPE=command MSG="action:prompt_text Nozzle swap complete?"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Complete|info"
    RESPOND TYPE=command MSG="action:prompt_button Retract|_Retract|info"
    RESPOND TYPE=command MSG="action:prompt_button Extrude|_Extrude|error"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _cold_nozzle]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M118 Heating to retract temp...
    M104 S{S.retract_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S.retract_temp}
    M118 Retracting filament...
    _Retract
    G4 P3000
    M118 Cooling to {S.cold_swap_temp}C...
    M104 S0
    M106 S255
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={S.cold_swap_temp}
    M106 S0
    RESPOND TYPE=command MSG="action:prompt_begin Swap Nozzle"
    RESPOND TYPE=command MSG="action:prompt_text Nozzle swap complete?"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Complete|info"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _Complete]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M118 Nozzle swap confirmed.
    {% if S.autoprobe_after_nozzle_change %}
        M118 Running auto probe test...
        _PROBE_TEST
    {% endif %}
    {% if not S.cold_swap_hotend %}
        M104 S0
    {% endif %}
    M118 Returning to Service menu...
    _SERVICE_MENU

[gcode_macro _Prompt2]
gcode:
    M118 Restoring position...
    RESTORE_GCODE_STATE NAME=SERVICE_STATE MOVE=1

[gcode_macro _Retract]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M118 Retract {{S.retract_distance}}mm
    G91
    G1 E-{S.retract_distance}
    G92 E0

[gcode_macro _Extrude]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M118 Extrude {{S.retract_distance}}mm
    G91
    G1 E{S.retract_distance}
    G92 E0
